<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Method – Enhanced Irregular Frame Solver</title>
    
    <!-- External Libraries -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* All CSS from original file */
        :root {
            --primary: #1a73e8;
            --primary-dark: #0d47a1;
            --secondary: #6c757d;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --light: #f8f9fa;
            --dark: #343a40;
            --gray: #6c757d;
            --gray-light: #e9ecef;
            --blue-light: #e3f2fd;
            --border-radius: 12px;
            --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --box-shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.12);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
        }

        h1, h2, h3, h4, h5, h6 {
            font-weight: 700;
            line-height: 1.3;
            margin-bottom: 1rem;
            color: var(--primary-dark);
        }

        h1 { font-size: 2.2rem; }
        h2 { font-size: 1.8rem; }
        h3 { font-size: 1.5rem; }
        h4 { font-size: 1.2rem; }

        p {
            margin-bottom: 1rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .navbar {
            background: linear-gradient(90deg, var(--primary-dark) 0%, var(--primary) 100%);
            color: white;
            padding: 16px 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            font-size: 1.3rem;
        }

        .brand-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }

        .nav-links {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .card {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--box-shadow);
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: var(--box-shadow-hover);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--gray-light);
        }

        .card-header i {
            color: var(--primary);
            font-size: 1.5rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            text-decoration: none;
            border: none;
            cursor: pointer;
            transition: var(--transition);
            font-size: 16px;
            white-space: nowrap;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(26, 115, 232, 0.3);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-block {
            width: 100%;
            padding: 16px;
            font-size: 1.1rem;
        }

        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--gray-light);
            border-radius: 8px;
            font-size: 16px;
            transition: var(--transition);
            background: white;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
        }

        .input-group small {
            display: block;
            margin-top: 5px;
            color: var(--gray);
            font-size: 0.85rem;
        }

        .grid {
            display: grid;
            gap: 20px;
        }

        .grid-2 {
            grid-template-columns: repeat(2, 1fr);
        }

        .grid-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        .table-responsive {
            overflow-x: auto;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid var(--gray-light);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        table th, table td {
            padding: 14px 16px;
            text-align: center;
            border: 1px solid var(--gray-light);
        }

        table th {
            background: var(--blue-light);
            font-weight: 600;
            color: var(--primary-dark);
            position: sticky;
            top: 0;
        }

        table tr:nth-child(even) {
            background: #f9f9f9;
        }

        table tr:hover {
            background: #f1f7ff;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: white;
            border: 2px solid var(--gray-light);
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
        }

        .checkbox-label:hover {
            border-color: var(--primary);
            background: #f0f7ff;
        }

        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .alert {
            padding: 18px 20px;
            border-radius: 8px;
            margin: 20px 0;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .alert i {
            font-size: 1.3rem;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .alert-info {
            background: #e8f4fd;
            border-left: 4px solid var(--primary);
            color: #0c5460;
        }

        .alert-error {
            background: #fdeaea;
            border-left: 4px solid var(--danger);
            color: #721c24;
        }

        .alert-success {
            background: #edf7ed;
            border-left: 4px solid var(--success);
            color: #155724;
        }

        .viz-container {
            width: 100%;
            overflow-x: auto;
            background: white;
            border: 1px solid var(--gray-light);
            border-radius: 8px;
            margin: 20px 0;
            padding: 15px;
            text-align: center;
        }

        #structureCanvas {
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            cursor: crosshair;
            max-width: 100%;
            height: auto;
        }

        .viz-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .viz-btn {
            font-size: 14px;
            padding: 8px 16px;
            border: 2px solid var(--gray-light);
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
        }

        .viz-btn:hover {
            border-color: var(--primary);
            background: #f0f7ff;
        }

        .viz-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .step-container {
            margin: 25px 0;
            padding: 20px;
            background: var(--light);
            border-radius: 8px;
            border-left: 4px solid var(--primary);
            display: none;
        }

        .step-container.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .step-title {
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3rem;
        }

        .step-formula {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: 'Times New Roman', serif;
            border: 1px solid var(--gray-light);
        }

        .step-details {
            margin-top: 15px;
            padding-left: 20px;
        }

        .step-details li {
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }

        .step-details li:last-child {
            border-bottom: none;
        }

        .results-section {
            margin-top: 30px;
        }

        .result-card {
            background: #f8fbff;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #e1ecff;
        }

        .result-card h4 {
            margin-top: 0;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .footer {
            margin-top: 40px;
            padding: 20px;
            text-align: center;
            color: var(--gray);
            font-size: 14px;
            border-top: 1px solid var(--gray-light);
            background: white;
            border-radius: var(--border-radius);
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .navbar {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }
            
            .nav-links {
                width: 100%;
                justify-content: center;
            }
            
            h1 { font-size: 1.8rem; }
            h2 { font-size: 1.5rem; }
            h3 { font-size: 1.3rem; }
            
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }
            
            .card {
                padding: 20px;
            }
            
            .btn {
                padding: 10px 16px;
                font-size: 15px;
            }
            
            .btn-block {
                padding: 14px;
            }
            
            .table-responsive {
                margin: 15px -15px;
                border-radius: 0;
                border-left: none;
                border-right: none;
            }
            
            .viz-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .viz-btn {
                justify-content: center;
            }
            
            .checkbox-group {
                flex-direction: column;
            }
            
            .step-formula {
                padding: 15px;
                overflow-x: auto;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .card {
                padding: 15px;
            }
            
            .input-group input, .input-group select {
                padding: 12px;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media print {
            .navbar, .viz-controls, .btn-group, .footer {
                display: none !important;
            }
            
            .card {
                box-shadow: none;
                border: 1px solid #ddd;
            }
            
            .step-container {
                break-inside: avoid;
            }
            
            table {
                break-inside: avoid;
            }
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: var(--dark);
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85rem;
            font-weight: normal;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
            animation: fadeIn 0.3s ease;
            overflow-y: auto;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            animation: slideIn 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            background: linear-gradient(90deg, var(--primary-dark) 0%, var(--primary) 100%);
            color: white;
            padding: 20px 25px;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .modal-header h3 {
            margin: 0;
            color: white;
            font-size: 1.4rem;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 25px;
            line-height: 1.7;
            overflow-y: auto;
            flex: 1;
        }

        .modal-team {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .team-member {
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
            border-bottom: 4px solid #002366;
            text-align: center;
        }

        .team-member i {
            color: var(--primary);
            font-size: 1.2rem;
            margin-bottom: 8px;
        }

        .project-title {
            background: var(--blue-light);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #002366;
            font-style: italic;
            text-align: center;
        }

        .project-title strong {
            color: var(--primary-dark);
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-body::-webkit-scrollbar {
            width: 6px;
        }

        .modal-body::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }

        .modal-body::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }

        .export-btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .export-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: var(--transition);
        }

        .export-btn:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .export-btn.pdf {
            background: #dc3545;
        }

        .export-btn.pdf:hover {
            background: #c82333;
        }

        .export-btn.text {
            background: #28a745;
        }

        .export-btn.text:hover {
            background: #218838;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="brand">
            <div class="brand-icon">
                <i class="fas fa-building"></i>
            </div>
            <div>Portal Method Structural Analysis</div>
        </div>
        <div class="nav-links">
            <button class="btn btn-secondary" onclick="location.href='index.html'">
                <i class="fas fa-home"></i> Home
            </button>
            <button class="btn btn-secondary" onclick="openAboutModal()">
                <i class="fas fa-info-circle"></i> About
            </button>
            <button class="btn btn-secondary" onclick="window.print()">
                <i class="fas fa-print"></i> Print
            </button>
            <div style="font-size: 13px; background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 20px;">
                v4.5 | BSCE 4 – 2025
            </div>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-building"></i>
                <h1>Enhanced Irregular Frame Solver</h1>
            </div>
            <p style="color: var(--gray); font-size: 16px; margin-bottom: 20px;">
                Advanced portal method analysis for irregular structures with variable spans and missing members.
                Enter the structure configuration below and click "Compute Analysis" to get results.
            </p>

            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <div>
                    <strong>Irregular Structure Analysis</strong>
                    <p style="margin: 5px 0 0 0; font-size: 14px;">
                        This solver handles irregular frames where some spans may be missing at certain storey levels. 
                        Use the checkboxes to indicate which spans are active (present) at each storey.
                        <strong>Enter number of storeys (1-5) and spans (1-6) to begin.</strong>
                    </p>
                </div>
            </div>

            <div id="errorDisplay" class="alert alert-error" style="display: none;">
                <i class="fas fa-exclamation-circle"></i>
                <div>
                    <strong>Error:</strong> <span id="errorMessage"></span>
                </div>
            </div>

            <form id="irregularForm" onsubmit="return handleFormSubmit(event)">
                <div class="grid grid-2">
                    <div class="input-group">
                        <label for="numStoreys">
                            <i class="fas fa-layer-group"></i> Number of Storeys (1-5)
                        </label>
                        <input type="number" name="numStoreys" id="numStoreys" min="1" max="5" required onchange="updateForm()" placeholder="e.g. 3">
                        <small>Enter a number between 1 and 5</small>
                    </div>
                    <div class="input-group">
                        <label for="numSpans">
                            <i class="fas fa-grip-lines"></i> Number of Spans (1-6)
                        </label>
                        <input type="number" name="numSpans" id="numSpans" min="1" max="6" required onchange="updateForm()" placeholder="e.g. 3">
                        <small>Enter a number between 1 and 6</small>
                    </div>
                </div>

                <div id="dynamicInputs">
                    <!-- Dynamic inputs will be inserted here by JavaScript -->
                    <div class="card" style="text-align: center; padding: 40px 20px; background: var(--light);">
                        <i class="fas fa-arrow-up" style="font-size: 3rem; color: var(--primary); margin-bottom: 20px;"></i>
                        <h3 style="color: var(--primary);">Enter Structure Configuration</h3>
                        <p style="color: var(--gray); max-width: 500px; margin: 0 auto;">
                            Please enter the number of storeys (1-5) and spans (1-6) above to configure your structure.
                            The input form will appear here once valid numbers are entered.
                        </p>
                    </div>
                </div>

                <button type="submit" name="compute" class="btn btn-success btn-block">
                    <i class="fas fa-calculator"></i> Compute Irregular Frame Analysis
                </button>
            </form>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" style="display: none;"></div>

        <div class="footer">
            <div>Developed by BSCE 4 – Portal Method Project (2025)</div>
            <div style="margin-top: 8px; font-size: 12px; color: var(--gray);">
                Enhanced Irregular Frame Analysis - Version 4.5 | Professional Formulas with LaTeX
            </div>
            <div style="margin-top: 8px; font-size: 11px; color: var(--gray);">
                <i class="fas fa-mobile-alt"></i> Responsive Web App | <i class="fas fa-tablet-alt"></i> Mobile Optimized
            </div>
        </div>
    </div>

    <!-- ABOUT MODAL -->
    <div id="aboutModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-info-circle"></i> About This Project</h3>
                <button class="modal-close" onclick="closeAboutModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="project-title">
                    <strong>DEVELOPMENT OF A WEB-BASED APPLICATION FOR STRUCTURAL ANALYSIS USING THE PORTAL METHOD</strong>
                </div>
                
                <p>This project is developed by BSCE 4th Year Students from the BiPSU School of Engineering Civil Engineering Department, 
                demonstrating the application of structural analysis principles through modern web technologies.</p>
                
                <h4>Project Team:</h4>
                <div class="modal-team">
                    <div class="team-member">
                        <i class="fas fa-user-graduate"></i>
                        <div><strong>Lourd James Ando</strong></div>
                        <div style="font-size: 14px; color: var(--gray);">Civil Engineering</div>
                    </div>
                    <div class="team-member">
                        <i class="fas fa-user-graduate"></i>
                        <div><strong>Jim Ariel Diezmo</strong></div>
                        <div style="font-size: 14px; color: var(--gray);">Civil Engineering</div>
                    </div>
                    <div class="team-member">
                        <i class="fas fa-user-graduate"></i>
                        <div><strong>Karen Mangco</strong></div>
                        <div style="font-size: 14px; color: var(--gray);">Civil Engineering</div>
                    </div>
                    <div class="team-member">
                        <i class="fas fa-user-graduate"></i>
                        <div><strong>Roma Grace Romero</strong></div>
                        <div style="font-size: 14px; color: var(--gray);">Civil Engineering</div>
                    </div>
                </div>
                
                <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--gray-light);">
                    <h4>Project Description:</h4>
                    <p>This web application implements the Portal Method for analyzing irregular building frames subjected to lateral loads. 
                    It features step-by-step calculations, interactive visualizations, and comprehensive result reporting for educational 
                    and professional use in structural engineering.</p>
                    
                    <div style="background: var(--light); padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <strong>Features:</strong>
                        <ul style="margin: 10px 0 0 20px;">
                            <li>Irregular frame analysis with missing members</li>
                            <li>Interactive step-by-step solution</li>
                            <li>Visual representation of forces and moments</li>
                            <li>Export capabilities for reports</li>
                            <li>Mobile-responsive design</li>
                        </ul>
                    </div>
                    
                    <p style="margin-top: 20px; font-size: 14px; color: var(--gray); text-align: center;">
                        <i class="fas fa-graduation-cap"></i> BSCE 4th Year Project • Academic Year 2025
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentResults = null;
        let vizSettings = {
            shears: true,
            moments: true,
            axials: true,
            loads: false
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateForm();
            loadSavedData();
        });

        // ================= FORM FUNCTIONS =================
        function updateForm() {
            const numStoreys = parseInt(document.getElementById('numStoreys').value) || 0;
            const numSpans = parseInt(document.getElementById('numSpans').value) || 0;
            
            let dynamicHTML = '';
            
            if (numStoreys > 0 && numSpans > 0) {
                dynamicHTML += `
                    <div class="card" style="background: var(--light);">
                        <div class="card-header">
                            <i class="fas fa-weight-hanging"></i>
                            <h3>Storey Loads and Heights</h3>
                        </div>
                        <div class="grid grid-3" id="storeyInputs"></div>
                    </div>
                    
                    <div class="card" style="background: var(--light);">
                        <div class="card-header">
                            <i class="fas fa-ruler"></i>
                            <h3>Span Lengths</h3>
                        </div>
                        <div class="grid grid-2" id="spanInputs"></div>
                    </div>
                    
                    <div class="card" style="background: #fff8e6; border-left: 4px solid var(--warning);">
                        <div class="card-header">
                            <i class="fas fa-check-circle"></i>
                            <h3>Active Spans Configuration</h3>
                        </div>
                        <p style="color: var(--gray); font-size: 14px; margin-bottom: 15px;">
                            Check the boxes to indicate which spans exist at each storey level. Unchecked spans are inactive.
                        </p>
                        <div id="activeSpansTable"></div>
                    </div>
                `;
                
                document.getElementById('dynamicInputs').innerHTML = dynamicHTML;
                
                // Update sub-sections
                updateStoreyInputs(numStoreys);
                updateSpanInputs(numSpans);
                updateActiveSpansTable(numStoreys, numSpans);
            } else {
                dynamicHTML = `
                    <div class="card" style="text-align: center; padding: 40px 20px; background: var(--light);">
                        <i class="fas fa-arrow-up" style="font-size: 3rem; color: var(--primary); margin-bottom: 20px;"></i>
                        <h3 style="color: var(--primary);">Enter Structure Configuration</h3>
                        <p style="color: var(--gray); max-width: 500px; margin: 0 auto;">
                            Please enter the number of storeys (1-5) and spans (1-6) above to configure your structure.
                            The input form will appear here once valid numbers are entered.
                        </p>
                    </div>
                `;
                document.getElementById('dynamicInputs').innerHTML = dynamicHTML;
            }
        }

        function updateStoreyInputs(numStoreys) {
            let storeyHTML = '';
            for (let i = 1; i <= numStoreys; i++) {
                storeyHTML += `
                    <div class="input-group">
                        <label>Storey ${i} Load (kN)</label>
                        <input type="number" step="0.01" name="load_${i}" value="20.00" placeholder="e.g. 20" required>
                    </div>
                    <div class="input-group">
                        <label>Storey ${i} Height (m)</label>
                        <input type="number" step="0.01" name="height_${i}" value="4.00" placeholder="e.g. 4.0" required>
                    </div>
                    <div></div>
                `;
            }
            document.getElementById('storeyInputs').innerHTML = storeyHTML;
        }

        function updateSpanInputs(numSpans) {
            let spanHTML = '';
            for (let j = 1; j <= numSpans; j++) {
                spanHTML += `
                    <div class="input-group">
                        <label>Span ${j} Length (m)</label>
                        <input type="number" step="0.01" name="span_length_${j}" value="5.00" placeholder="e.g. 5.0" required>
                    </div>
                `;
            }
            document.getElementById('spanInputs').innerHTML = spanHTML;
        }

        function updateActiveSpansTable(numStoreys, numSpans) {
            let tableHTML = '<div class="table-responsive"><table><thead><tr><th>Storey</th>';
            for (let j = 1; j <= numSpans; j++) {
                tableHTML += `<th>Span ${j}</th>`;
            }
            tableHTML += '</tr></thead><tbody>';
            
            for (let i = numStoreys; i >= 1; i--) {
                tableHTML += `<tr><td><strong>Storey ${i}</strong></td>`;
                for (let j = 1; j <= numSpans; j++) {
                    tableHTML += `<td><label class="checkbox-label"><input type="checkbox" name="active_${i}_${j}" checked></label></td>`;
                }
                tableHTML += '</tr>';
            }
            tableHTML += '</tbody></table></div>';
            document.getElementById('activeSpansTable').innerHTML = tableHTML;
        }

        // ================= FORM SUBMISSION =================
        function handleFormSubmit(event) {
            event.preventDefault();
            
            if (!validateForm()) {
                return false;
            }
            
            const formData = new FormData(event.target);
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            
            try {
                const results = computeAnalysis(data);
                currentResults = results;
                displayResults(results);
                saveData(data);
            } catch (error) {
                showError(error.message);
            }
            
            return false;
        }

        function validateForm() {
            const numStoreys = parseInt(document.getElementById('numStoreys').value);
            const numSpans = parseInt(document.getElementById('numSpans').value);
            
            if (numStoreys < 1 || numStoreys > 5) {
                showError("Number of storeys must be between 1 and 5");
                return false;
            }
            
            if (numSpans < 1 || numSpans > 6) {
                showError("Number of spans must be between 1 and 6");
                return false;
            }
            
            return true;
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorDisplay').style.display = 'flex';
            
            setTimeout(() => {
                document.getElementById('errorDisplay').scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        function hideError() {
            document.getElementById('errorDisplay').style.display = 'none';
        }

        // ================= ANALYSIS COMPUTATION =================
        function computeAnalysis(data) {
            const numStoreys = parseInt(data.numStoreys);
            const numSpans = parseInt(data.numSpans);
            
            // Extract loads and heights
            const loads = {};
            const heights = {};
            for (let i = 1; i <= numStoreys; i++) {
                loads[i] = parseFloat(data[`load_${i}`]) || 0;
                heights[i] = parseFloat(data[`height_${i}`]) || 0;
            }
            
            // Extract span lengths
            const spanLengths = {};
            for (let j = 1; j <= numSpans; j++) {
                spanLengths[j] = parseFloat(data[`span_length_${j}`]) || 0;
            }
            
            // Extract active spans
            const activeSpans = {};
            for (let i = 1; i <= numStoreys; i++) {
                activeSpans[i] = {};
                for (let j = 1; j <= numSpans; j++) {
                    activeSpans[i][j] = data[`active_${i}_${j}`] === 'on' ? 1 : 0;
                }
            }
            
            // Perform portal method analysis
            return computeIrregularPortalMethod(numStoreys, numSpans, loads, heights, spanLengths, activeSpans);
        }

        function computeIrregularPortalMethod(numStoreys, numSpans, loads, heights, spanLengths, activeSpans) {
            const results = {
                numStoreys: numStoreys,
                numSpans: numSpans,
                loads: loads,
                heights: heights,
                spanLengths: spanLengths,
                activeSpans: activeSpans,
                columnShears: {},
                beamShears: {},
                beamAxialForces: {},
                columnMoments: {},
                storeyShears: {},
                axialForces: {},
                calculationSteps: {},
                exteriorCols: {},
                interiorCols: {},
                V_unit: {}
            };
            
            // ==================== STEP 1: Storey Shear Forces ====================
            let storeyShear = 0;
            for (let i = numStoreys; i >= 1; i--) {
                storeyShear += loads[i];
                results.storeyShears[i] = storeyShear;
                
                // Store calculation step
                results.calculationSteps[i] = results.calculationSteps[i] || {};
                results.calculationSteps[i].storeyShear = {
                    formula: 'V_{' + i + '} = \\sum_{j=' + i + '}^{' + numStoreys + '} P_j',
                    calculation: 'Storey ' + i + ': V = ' + storeyShear.toFixed(2) + ' kN'
                };
            }
            
            // ==================== STEP 2: Column Shear Forces ====================
            for (let i = 1; i <= numStoreys; i++) {
                // Determine active columns
                const activeColumns = [];
                for (let col = 0; col <= numSpans; col++) {
                    const leftSpanActive = (col > 0 && activeSpans[i][col] == 1);
                    const rightSpanActive = (col < numSpans && activeSpans[i][col+1] == 1);
                    
                    if (leftSpanActive || rightSpanActive) {
                        activeColumns.push(col);
                    }
                }
                
                // Classify columns
                const exteriorCols = [];
                const interiorCols = [];
                
                activeColumns.forEach((col, index) => {
                    if (index === 0 || index === activeColumns.length - 1) {
                        exteriorCols.push(col);
                    } else {
                        interiorCols.push(col);
                    }
                });
                
                // Structural boundary check
                if (activeColumns.includes(0) && !exteriorCols.includes(0)) {
                    exteriorCols.push(0);
                    const index = interiorCols.indexOf(0);
                    if (index !== -1) interiorCols.splice(index, 1);
                }
                if (activeColumns.includes(numSpans) && !exteriorCols.includes(numSpans)) {
                    exteriorCols.push(numSpans);
                    const index = interiorCols.indexOf(numSpans);
                    if (index !== -1) interiorCols.splice(index, 1);
                }
                
                // Store column classifications
                results.exteriorCols[i] = exteriorCols;
                results.interiorCols[i] = interiorCols;
                
                // Calculate V
                const numExterior = exteriorCols.length;
                const numInterior = interiorCols.length;
                const totalUnits = numExterior * 1 + numInterior * 2;
                const V = (totalUnits > 0) ? results.storeyShears[i] / totalUnits : 0;
                
                // Store V_unit
                results.V_unit[i] = V;
                
                // Store column shears
                results.columnShears[i] = {};
                exteriorCols.forEach(col => results.columnShears[i][col] = V);
                interiorCols.forEach(col => results.columnShears[i][col] = 2 * V);
            }
            
            // ==================== STEP 3: Column Moments ====================
            for (let i = 1; i <= numStoreys; i++) {
                results.columnMoments[i] = {};
                for (let col = 0; col <= numSpans; col++) {
                    if (results.columnShears[i] && results.columnShears[i][col] !== undefined) {
                        results.columnMoments[i][col] = results.columnShears[i][col] * (heights[i] / 2);
                    }
                }
            }
            
            // ==================== STEP 4: Beam Vertical Shears ====================
            for (let i = numStoreys; i >= 1; i--) {
                results.beamShears[i] = {};
                for (let span = 1; span <= numSpans; span++) {
                    if (activeSpans[i][span] == 1) {
                        const L = spanLengths[span];
                        const leftCol = span - 1;
                        
                        let sumColMoment = 0;
                        if (results.columnMoments[i] && results.columnMoments[i][leftCol]) {
                            sumColMoment += results.columnMoments[i][leftCol];
                        }
                        if (i < numStoreys && results.columnMoments[i+1] && results.columnMoments[i+1][leftCol]) {
                            sumColMoment += results.columnMoments[i+1][leftCol];
                        }
                        
                        let prevBeamMoment = 0;
                        if (span > 1 && results.beamShears[i] && results.beamShears[i][span-1]) {
                            const L_prev = spanLengths[span-1];
                            prevBeamMoment = results.beamShears[i][span-1] * (L_prev / 2);
                        }
                        
                        const V_beam = (sumColMoment - prevBeamMoment) / (L / 2);
                        results.beamShears[i][span] = V_beam;
                    }
                }
            }
            
            // ==================== STEP 5: Beam Axial Forces ====================
            for (let i = numStoreys; i >= 1; i--) {
                results.beamAxialForces[i] = {};
                for (let col = 0; col < numSpans; col++) {
                    const P_ext = (col == 0) ? loads[i] : 0;
                    
                    let H_left = 0;
                    if (col > 0 && results.beamAxialForces[i] && results.beamAxialForces[i][col]) {
                        H_left = results.beamAxialForces[i][col];
                    }
                    
                    let V_top = 0;
                    if (i < numStoreys && results.columnShears[i+1] && results.columnShears[i+1][col]) {
                        V_top = results.columnShears[i+1][col];
                    }
                    
                    let V_bot = 0;
                    if (results.columnShears[i] && results.columnShears[i][col]) {
                        V_bot = results.columnShears[i][col];
                    }
                    
                    const rightSpanIndex = col + 1;
                    if (activeSpans[i][rightSpanIndex] == 1) {
                        const H_right = P_ext + H_left + V_top - V_bot;
                        results.beamAxialForces[i][rightSpanIndex] = H_right;
                    }
                }
            }
            
            // Calculate axial forces for columns
            for (let i = 1; i <= numStoreys; i++) {
                results.axialForces[i] = {};
                for (let col = 0; col <= numSpans; col++) {
                    let axial = 0;
                    // Sum beam axial forces from above
                    for (let k = i + 1; k <= numStoreys; k++) {
                        if (results.beamAxialForces[k] && results.beamAxialForces[k][col]) {
                            axial += results.beamAxialForces[k][col];
                        }
                        if (results.beamAxialForces[k] && results.beamAxialForces[k][col + 1]) {
                            axial -= results.beamAxialForces[k][col + 1];
                        }
                    }
                    results.axialForces[i][col] = axial;
                }
            }
            
            return results;
        }

        // ================= RESULTS DISPLAY =================
        function displayResults(results) {
            hideError();
            
            const resultsHTML = `
                <div class="results-section">
                    <!-- Step-by-Step Explanation -->
                    <div class="card">
                        <div class="card-header" style="justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <i class="fas fa-list-ol"></i>
                                <h2>Step-by-Step Solution</h2>
                            </div>
                            <div class="export-btn-group">
                                <button class="export-btn text" onclick="exportStepsAsText()">
                                    <i class="fas fa-file-alt"></i> Export as Text
                                </button>
                                <button class="export-btn pdf" onclick="exportStepsAsPDF()">
                                    <i class="fas fa-file-pdf"></i> Export as PDF
                                </button>
                            </div>
                        </div>
                        <div class="viz-controls">
                            <button class="viz-btn active" onclick="showStep('step1')">
                                <i class="fas fa-1"></i> Storey Shears
                            </button>
                            <button class="viz-btn" onclick="showStep('step2')">
                                <i class="fas fa-2"></i> Column Shears
                            </button>
                            <button class="viz-btn" onclick="showStep('step3')">
                                <i class="fas fa-3"></i> Moments
                            </button>
                            <button class="viz-btn" onclick="showStep('step4')">
                                <i class="fas fa-4"></i> Beam Shears
                            </button>
                            <button class="viz-btn" onclick="showStep('step5')">
                                <i class="fas fa-5"></i> Axial Forces
                            </button>
                        </div>
                        
                        <div id="step1" class="step-container active">
                            <div class="step-title">
                                <i class="fas fa-calculator"></i>
                                Step 1: Calculate Storey Shear Forces
                            </div>
                            <div class="step-formula">
                                <p>$$V_i = \\sum_{j=i}^{n} P_j$$</p>
                                <p>Where \\(V_i\\) is the shear at storey \\(i\\), and \\(P_j\\) are the lateral loads.</p>
                            </div>
                            <ul class="step-details">
                                ${generateStoreyShearSteps(results)}
                            </ul>
                        </div>
                        
                        <div id="step2" class="step-container">
                            <div class="step-title">
                                <i class="fas fa-columns"></i>
                                Step 2: Distribute Column Shear Forces
                            </div>
                            <div class="step-formula">
                                <p>$$V_{unit} = \\frac{V_{storey}}{\\sum units}$$</p>
                                <p>Where \\(\\sum units = (\\text{# exterior columns}) \\times 1 + (\\text{# interior columns}) \\times 2\\)</p>
                            </div>
                            ${generateColumnShearSteps(results)}
                        </div>
                        
                        <div id="step3" class="step-container">
                            <div class="step-title">
                                <i class="fas fa-torii-gate"></i>
                                Step 3: Calculate Column Moments
                            </div>
                            <div class="step-formula">
                                <p>$$M_{col} = V_{col} \\times \\frac{h}{2}$$</p>
                                <p>Assumes points of contraflexure at mid-height of columns.</p>
                            </div>
                            <ul class="step-details">
                                ${generateColumnMomentSteps(results)}
                            </ul>
                        </div>
                        
                        <div id="step4" class="step-container">
                            <div class="step-title">
                                <i class="fas fa-grip-lines"></i>
                                Step 4: Calculate Beam Vertical Shears
                            </div>
                            <div class="step-formula">
                                <p>$$V_{beam} = \\frac{\\sum M_{columns} - M_{beam,prev}}{L/2}$$</p>
                                <p>Where moments are taken about beam-column joints.</p>
                            </div>
                            <ul class="step-details">
                                ${generateBeamShearSteps(results)}
                            </ul>
                        </div>
                        
                        <div id="step5" class="step-container">
                            <div class="step-title">
                                <i class="fas fa-arrows-alt-h"></i>
                                Step 5: Calculate Beam Axial Forces (Horizontal Shears)
                            </div>
                            <div class="step-formula">
                                <p>$$H_{right} = P_{ext} + H_{left} + V_{top} - V_{bottom}$$</p>
                                <p>Horizontal equilibrium at beam-column joints.</p>
                            </div>
                            <ul class="step-details">
                                ${generateBeamAxialSteps(results)}
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Visualization -->
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-project-diagram"></i>
                            <h2>Structural Visualization</h2>
                        </div>
                        <p style="font-size: 14px; color: var(--gray); margin-bottom: 15px;">
                            Interactive Diagram: Hinges indicate points of contraflexure (zero moment). Hover over badges for values.
                        </p>
                        
                        <div class="viz-controls">
                            <button class="viz-btn active" onclick="toggleLayer('shears')">
                                <i class="fas fa-arrows-alt-v"></i> Show Shear (V)
                            </button>
                            <button class="viz-btn active" onclick="toggleLayer('moments')">
                                <i class="fas fa-redo-alt"></i> Show Moments (M)
                            </button>
                            <button class="viz-btn active" onclick="toggleLayer('axials')">
                                <i class="fas fa-arrows-alt-h"></i> Show Axial (P/H)
                            </button>
                            <button class="viz-btn" onclick="toggleLayer('loads')">
                                <i class="fas fa-weight-hanging"></i> Show Loads
                            </button>
                            <button class="btn btn-secondary" onclick="downloadCanvas()">
                                <i class="fas fa-download"></i> Download Diagram
                            </button>
                        </div>

                        <div class="viz-container">
                            <canvas id="structureCanvas"></canvas>
                        </div>
                        
                        <div style="margin-top: 15px; font-size: 13px; color: var(--gray); text-align: center; line-height: 1.6;">
                            <div><i class="fas fa-circle" style="color: white; background: #333; border-radius: 50%; padding: 3px;"></i> White circles = Hinges (points of contraflexure)</div>
                            <div><span style="color: #007bff;">🟦 Blue</span> = Shear forces | <span style="color: #28a745;">🟩 Green</span> = Axial forces | <span style="color: #6f42c1;">🟪 Purple</span> = Column shears</div>
                        </div>
                    </div>

                    <!-- Detailed Results -->
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-chart-bar"></i>
                            <h2>Detailed Analysis Results</h2>
                        </div>
                        
                        ${generateDetailedResults(results)}
                        
                        <div class="btn-group">
                            <button onclick="window.print()" class="btn btn-primary">
                                <i class="fas fa-print"></i> Print Results
                            </button>
                            <button onclick="resetForm()" class="btn btn-secondary">
                                <i class="fas fa-sync-alt"></i> New Analysis
                            </button>
                            <button onclick="location.href='index.html'" class="btn btn-secondary">
                                <i class="fas fa-home"></i> Home
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('resultsSection').innerHTML = resultsHTML;
            document.getElementById('resultsSection').style.display = 'block';
            
            // Initialize visualization
            setTimeout(() => {
                initVisualization();
                if (typeof MathJax !== 'undefined') {
                    MathJax.typesetPromise();
                }
            }, 100);
            
            // Scroll to results
            setTimeout(() => {
                document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
            }, 200);
        }

        // Helper functions for generating result sections
        function generateStoreyShearSteps(results) {
            let html = '';
            for (let i = results.numStoreys; i >= 1; i--) {
                let sum = 0;
                let calc = '';
                for (let j = i; j <= results.numStoreys; j++) {
                    sum += results.loads[j];
                    calc += results.loads[j].toFixed(2);
                    if (j < results.numStoreys) calc += ' + ';
                }
                html += `<li>Storey ${i}: \\(V_{${i}} = ${calc} = ${results.storeyShears[i].toFixed(2)} \\text{ kN}\\)</li>`;
            }
            return html;
        }

        function generateColumnShearSteps(results) {
            let html = '';
            for (let i = 1; i <= results.numStoreys; i++) {
                const activeCols = [];
                for (let col = 0; col <= results.numSpans; col++) {
                    if (results.columnShears[i] && results.columnShears[i][col] !== undefined) {
                        activeCols.push(col);
                    }
                }
                
                const extCols = results.exteriorCols[i] || [];
                const intCols = results.interiorCols[i] || [];
                const totalUnits = extCols.length * 1 + intCols.length * 2;
                
                html += `
                    <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 8px; border: 1px solid var(--gray-light);">
                        <strong>Storey ${i}:</strong>
                        <ul class="step-details">
                            <li>Storey shear: \\(V_{${i}} = ${results.storeyShears[i].toFixed(2)} \\text{ kN}\\)</li>
                            <li>Active columns: ${activeCols.join(', ')}</li>
                            <li>Exterior columns (1V): ${extCols.join(', ')}</li>
                            <li>Interior columns (2V): ${intCols.join(', ')}</li>
                            <li>\\(V_{unit} = \\frac{${results.storeyShears[i].toFixed(2)}}{${totalUnits}} = ${results.V_unit[i].toFixed(3)} \\text{ kN}\\)</li>
                        </ul>
                    </div>
                `;
            }
            return html;
        }

        function generateColumnMomentSteps(results) {
            let html = '';
            for (let i = 1; i <= results.numStoreys; i++) {
                for (let col = 0; col <= results.numSpans; col++) {
                    if (results.columnShears[i] && results.columnShears[i][col] !== undefined) {
                        html += `<li>Storey ${i}, Column ${col}: \\(M = ${results.columnShears[i][col].toFixed(2)} \\times \\frac{${results.heights[i].toFixed(2)}}{2} = ${results.columnMoments[i][col].toFixed(2)} \\text{ kN·m}\\)</li>`;
                    }
                }
            }
            return html;
        }

        function generateBeamShearSteps(results) {
            let html = '';
            for (let i = results.numStoreys; i >= 1; i--) {
                for (let span = 1; span <= results.numSpans; span++) {
                    if (results.beamShears[i] && results.beamShears[i][span] !== undefined) {
                        html += `<li>Storey ${i}, Span ${span}: \\(V = ${results.beamShears[i][span].toFixed(2)} \\text{ kN}\\)</li>`;
                    }
                }
            }
            return html;
        }

        function generateBeamAxialSteps(results) {
            let html = '';
            for (let i = results.numStoreys; i >= 1; i--) {
                for (let span = 1; span <= results.numSpans; span++) {
                    if (results.beamAxialForces[i] && results.beamAxialForces[i][span] !== undefined) {
                        html += `<li>Storey ${i}, Span ${span}: \\(H = ${results.beamAxialForces[i][span].toFixed(2)} \\text{ kN}\\)</li>`;
                    }
                }
            }
            return html;
        }

        function generateDetailedResults(results) {
            let html = '';
            
            // Storey Shear Forces
            html += `
                <div class="result-card">
                    <h4><i class="fas fa-weight"></i> 1. Storey Shear Forces</h4>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Storey</th>
                                    <th>Load (kN)</th>
                                    <th>Height (m)</th>
                                    <th>Cumulative Shear (kN)</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            for (let i = results.numStoreys; i >= 1; i--) {
                html += `
                    <tr>
                        <td>Storey ${i}</td>
                        <td>${results.loads[i].toFixed(2)}</td>
                        <td>${results.heights[i].toFixed(2)}</td>
                        <td><strong>${results.storeyShears[i].toFixed(2)}</strong></td>
                    </tr>
                `;
            }
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            // Column Shear Forces
            html += `
                <div class="result-card">
                    <h4><i class="fas fa-columns"></i> 2. Column Shear Forces (V & 2V Distribution)</h4>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Storey</th>
            `;
            
            for (let j = 0; j <= results.numSpans; j++) {
                html += `<th>Column ${j}</th>`;
            }
            
            html += `
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            for (let i = results.numStoreys; i >= 1; i--) {
                html += `<tr><td>Storey ${i}</td>`;
                
                for (let j = 0; j <= results.numSpans; j++) {
                    if (results.columnShears[i] && results.columnShears[i][j] !== undefined) {
                        let type = '';
                        if (results.exteriorCols[i] && results.exteriorCols[i].includes(j)) {
                            type = '<br><small style="color: var(--gray);">(Exterior: 1V)</small>';
                        } else if (results.interiorCols[i] && results.interiorCols[i].includes(j)) {
                            type = '<br><small style="color: var(--gray);">(Interior: 2V)</small>';
                        }
                        html += `<td>${results.columnShears[i][j].toFixed(2)} kN${type}</td>`;
                    } else {
                        html += '<td><span style="color: #ccc;">—</span></td>';
                    }
                }
                
                html += '</tr>';
            }
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            // Add more result tables as needed...
            
            return html;
        }

        // ================= VISUALIZATION =================
        function initVisualization() {
            if (!currentResults) return;
            
            const canvas = document.getElementById('structureCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const padding = 80;
            const storeyHeightPixels = 100;
            const spanWidthPixels = 120;
            
            const requiredWidth = (currentResults.numSpans * spanWidthPixels) + (padding * 2);
            const requiredHeight = (currentResults.numStoreys * storeyHeightPixels) + (padding * 2);
            
            canvas.width = Math.max(800, requiredWidth);
            canvas.height = Math.max(500, requiredHeight);
            
            drawStructure(ctx, canvas);
        }

        function drawStructure(ctx, canvas) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const padding = 80;
            const storeyHeightPixels = 100;
            const spanWidthPixels = 120;
            
            // Calculate center position
            const centerX = canvas.width / 2;
            const structureWidth = currentResults.numSpans * spanWidthPixels;
            const startX = centerX - (structureWidth / 2);
            const startY = canvas.height - padding;
            
            // Helper functions
            const getX = (colIdx) => startX + (colIdx * spanWidthPixels);
            const getY = (storeyIdx) => startY - ((storeyIdx - 0) * storeyHeightPixels);
            
            // Draw columns
            ctx.lineWidth = 3;
            ctx.strokeStyle = '#333';
            
            for (let i = 1; i <= currentResults.numStoreys; i++) {
                for (let col = 0; col <= currentResults.numSpans; col++) {
                    let leftActive = (col > 0 && currentResults.activeSpans[i][col] == 1);
                    let rightActive = (col < currentResults.numSpans && currentResults.activeSpans[i][col+1] == 1);
                    
                    if (leftActive || rightActive) {
                        const x = getX(col);
                        const yTop = getY(i);
                        const yBot = getY(i-1);
                        
                        // Draw column
                        ctx.beginPath();
                        ctx.moveTo(x, yBot);
                        ctx.lineTo(x, yTop);
                        ctx.stroke();
                        
                        // Draw hinge (circle) at mid-height
                        const midY = (yTop + yBot) / 2;
                        ctx.beginPath();
                        ctx.arc(x, midY, 6, 0, Math.PI * 2);
                        ctx.fillStyle = 'white';
                        ctx.fill();
                        ctx.strokeStyle = '#333';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                    }
                }
            }
            
            // Draw beams
            for (let i = 1; i <= currentResults.numStoreys; i++) {
                for (let span = 1; span <= currentResults.numSpans; span++) {
                    if (currentResults.activeSpans[i][span] == 1) {
                        const xLeft = getX(span - 1);
                        const xRight = getX(span);
                        const y = getY(i);
                        
                        // Draw beam
                        ctx.beginPath();
                        ctx.moveTo(xLeft, y);
                        ctx.lineTo(xRight, y);
                        ctx.stroke();
                        
                        // Draw hinge at mid-span
                        const midX = (xLeft + xRight) / 2;
                        ctx.beginPath();
                        ctx.arc(midX, y, 6, 0, Math.PI * 2);
                        ctx.fillStyle = 'white';
                        ctx.fill();
                        ctx.strokeStyle = '#333';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                    }
                }
            }
            
            // Draw labels for forces
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // Draw column shear labels
            if (vizSettings.shears) {
                ctx.fillStyle = '#6f42c1';
                for (let i = 1; i <= currentResults.numStoreys; i++) {
                    for (let col = 0; col <= currentResults.numSpans; col++) {
                        if (currentResults.columnShears[i] && currentResults.columnShears[i][col] !== undefined) {
                            const x = getX(col);
                            const yMid = (getY(i) + getY(i-1)) / 2;
                            ctx.fillText(`V=${currentResults.columnShears[i][col].toFixed(1)}`, x - 25, yMid);
                        }
                    }
                }
            }
            
            // Draw beam shear labels
            if (vizSettings.shears) {
                ctx.fillStyle = '#007bff';
                for (let i = 1; i <= currentResults.numStoreys; i++) {
                    for (let span = 1; span <= currentResults.numSpans; span++) {
                        if (currentResults.beamShears[i] && currentResults.beamShears[i][span] !== undefined) {
                            const xMid = (getX(span-1) + getX(span)) / 2;
                            const y = getY(i);
                            ctx.fillText(`V=${currentResults.beamShears[i][span].toFixed(1)}`, xMid, y - 25);
                        }
                    }
                }
            }
            
            // Draw beam axial labels
            if (vizSettings.axials) {
                ctx.fillStyle = '#28a745';
                for (let i = 1; i <= currentResults.numStoreys; i++) {
                    for (let span = 1; span <= currentResults.numSpans; span++) {
                        if (currentResults.beamAxialForces[i] && currentResults.beamAxialForces[i][span] !== undefined) {
                            const xMid = (getX(span-1) + getX(span)) / 2;
                            const y = getY(i);
                            ctx.fillText(`H=${currentResults.beamAxialForces[i][span].toFixed(1)}`, xMid, y + 25);
                        }
                    }
                }
            }
        }

        // ================= STEP FUNCTIONS =================
        function showStep(stepId) {
            const steps = document.querySelectorAll('.step-container');
            steps.forEach(step => step.classList.remove('active'));
            
            const stepElement = document.getElementById(stepId);
            if (stepElement) {
                stepElement.classList.add('active');
            }
            
            const buttons = document.querySelectorAll('.viz-controls .viz-btn');
            buttons.forEach(btn => {
                if (btn.textContent.includes(stepId.replace('step', ''))) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            if (typeof MathJax !== 'undefined') {
                MathJax.typesetPromise([`#${stepId}`]);
            }
        }

        function toggleLayer(layer) {
            vizSettings[layer] = !vizSettings[layer];
            
            const btns = document.querySelectorAll('.viz-btn');
            btns.forEach(btn => {
                if (btn.innerText.includes('Shear') && layer === 'shears') btn.classList.toggle('active');
                if (btn.innerText.includes('Moment') && layer === 'moments') btn.classList.toggle('active');
                if (btn.innerText.includes('Axial') && layer === 'axials') btn.classList.toggle('active');
                if (btn.innerText.includes('Loads') && layer === 'loads') btn.classList.toggle('active');
            });
            
            if (currentResults) {
                initVisualization();
            }
        }

        // ================= EXPORT FUNCTIONS =================
        function exportStepsAsText() {
            if (!currentResults) return;
            
            let exportContent = "PORTAL METHOD ANALYSIS - STEP-BY-STEP SOLUTION\n";
            exportContent += "==============================================\n\n";
            
            // Add basic info
            exportContent += `Number of Storeys: ${currentResults.numStoreys}\n`;
            exportContent += `Number of Spans: ${currentResults.numSpans}\n\n`;
            
            // Storey shears
            exportContent += "STOREY SHEAR FORCES:\n";
            for (let i = currentResults.numStoreys; i >= 1; i--) {
                exportContent += `  Storey ${i}: ${currentResults.storeyShears[i].toFixed(2)} kN\n`;
            }
            
            // Column shears
            exportContent += "\nCOLUMN SHEAR FORCES:\n";
            for (let i = 1; i <= currentResults.numStoreys; i++) {
                exportContent += `  Storey ${i}:\n`;
                for (let col = 0; col <= currentResults.numSpans; col++) {
                    if (currentResults.columnShears[i] && currentResults.columnShears[i][col] !== undefined) {
                        exportContent += `    Column ${col}: ${currentResults.columnShears[i][col].toFixed(2)} kN\n`;
                    }
                }
            }
            
            // Create and download file
            const blob = new Blob([exportContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `portal-method-analysis-${new Date().toISOString().slice(0,10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('Analysis exported as text file!');
        }

        function exportStepsAsPDF() {
            alert('PDF export requires additional libraries. Please use the Print function (Ctrl+P) or Text Export.');
        }

        function downloadCanvas() {
            const canvas = document.getElementById('structureCanvas');
            if (!canvas) return;
            
            const link = document.createElement('a');
            link.download = `frame-diagram-${new Date().toISOString().slice(0,10)}.png`;
            link.href = canvas.toDataURL('image/png');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ================= MODAL FUNCTIONS =================
        function openAboutModal() {
            document.getElementById('aboutModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            const modalBody = document.querySelector('.modal-body');
            if (modalBody) {
                modalBody.scrollTop = 0;
            }
        }

        function closeAboutModal() {
            document.getElementById('aboutModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // ================= UTILITY FUNCTIONS =================
        function resetForm() {
            document.getElementById('numStoreys').value = '';
            document.getElementById('numSpans').value = '';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('errorDisplay').style.display = 'none';
            updateForm();
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function saveData(data) {
            try {
                localStorage.setItem('portalMethodData', JSON.stringify(data));
            } catch (e) {
                console.warn('Could not save to localStorage:', e);
            }
        }

        function loadSavedData() {
            try {
                const savedData = localStorage.getItem('portalMethodData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    if (data.numStoreys) {
                        document.getElementById('numStoreys').value = data.numStoreys;
                    }
                    if (data.numSpans) {
                        document.getElementById('numSpans').value = data.numSpans;
                    }
                    updateForm();
                }
            } catch (e) {
                console.warn('Could not load from localStorage:', e);
            }
        }

        // Event listeners for modal
        window.onclick = function(event) {
            const modal = document.getElementById('aboutModal');
            if (event.target === modal) {
                closeAboutModal();
            }
        };

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeAboutModal();
            }
        });

        // Add roundedRect function to CanvasRenderingContext2D
        if (!CanvasRenderingContext2D.prototype.roundRect) {
            CanvasRenderingContext2D.prototype.roundRect = function(x, y, width, height, radius) {
                if (width < 2 * radius) radius = width / 2;
                if (height < 2 * radius) radius = height / 2;
                this.beginPath();
                this.moveTo(x + radius, y);
                this.arcTo(x + width, y, x + width, y + height, radius);
                this.arcTo(x + width, y + height, x, y + height, radius);
                this.arcTo(x, y + height, x, y, radius);
                this.arcTo(x, y, x + width, y, radius);
                this.closePath();
                return this;
            };
        }
    </script>
</body>
</html>